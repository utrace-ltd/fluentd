<match kubernetes.var.log.containers.**_kube-system_**>
    @type null
</match>

<match kubelet>
    @type null
</match>

<filter **>
  @type record_transformer
  <record>
    fluentd_cluster_name "#{ENV['FLUENTD_CLUSETR_NAME']}"
  </record>
</filter>

<filter kubernetes.**>
    @type kubernetes_metadata
    skip_labels true
    skip_container_metadata true
    skip_master_url true
    skip_namespace_metadata true
</filter>

<filter kubernetes.**>
    @type grep
    <exclude>
        key log
        pattern /healthcheck/
    </exclude>
</filter>

<filter kubernetes.**>
    @type grep
    <exclude>
        key log
        pattern /healthCheck/
    </exclude>
</filter>

<filter kubernetes.var.log.containers.**>
    @type parser
    <parse>
        @type json
        json_parser json
    </parse>
    replace_invalid_sequence true
    emit_invalid_record_to_error false
    key_name log
    reserve_data true
    remove_key_name_field true
    reserve_time
</filter>

<match **>
    @type elasticsearch_dynamic
    host "#{ENV['ELASTICSEARCH_HOST']}"
    port "#{ENV['ELASTICSEARCH_PORT']}"
    type_name fluentd
    include_tag_key true
    logstash_format true
    logstash_prefix kube-${record['fluentd_cluster_name']}-${record['kubernetes']['namespace_name']}
    reconnect_on_error true
    reload_on_failure true
    reload_connections false
    <buffer>
        @type file
        path /var/log/fluentd-buffers/kubernetes.system.buffer
        flush_mode interval
        retry_type exponential_backoff
        flush_thread_count 2
        flush_interval 5s
        retry_forever
        retry_max_interval 30
        chunk_limit_size 8M
        queue_limit_length 16
        overflow_action block
    </buffer>
</match>
